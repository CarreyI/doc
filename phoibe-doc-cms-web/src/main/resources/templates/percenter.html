<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>个人中心</title>
    <script src="js/jquery-2.1.0.min.js"></script>
     <script src="js/percenter.js"></script>
      <script src="js/layui.js"></script>
    <link rel="stylesheet" href="css/management.css"/>
        <link rel="stylesheet" href="css/layui.css">
    <link href="js/webuploader-0.1.5/webuploader.css" rel="stylesheet"
	type="text/css" />
<!-- 引入文件上传插件 -->
<script type="text/javascript"
	src="js/webuploader-0.1.5/webuploader.min.js"></script>
    <style>
        .widget-box ul li a {
        padding:0px;
}
    </style>
</head>
<body>
    <div id="percenter">
     <div class="main box_border">
            <div class="container box_border">
                <div class="box_border">
                 <div class="bg_whiteSD box_border top inputblock">
                    <div class="plateHeader i-percener"></div>
        
                     <div class="sidebar">

	<div class="widget widget-tab">
        
		<input type="radio" name="widget-tab" value="1" id="new" checked="checked" style="display:none;"/>
		<input type="radio" name="widget-tab" value="2" id="hot" style="display:none;"/>
        <input type="radio" name="widget-tab" value="3" id="random" style="display:none;"/>
		<div class="widget-title inline-ul">
			<ul>
				<li class="new">
					<label for="new">文档动态</label>
				</li>

				<li class="hot">
					<label for="hot">最近浏览</label>

				</li >
                	<li class="random">
					<label for="random">我的收藏</label>
				</li>
       
			</ul>
		</div>
		<div class="widget-box">
            <ul class="new-list">
				<li id="docdym">
				</li>
			</ul>
			<ul class="hot-list">
				<li id="nearread">   
				</li>
			</ul>
            <ul class="random-list">
				<li>
                    <ol class="list1"><li><div>暂未收藏任何文档</div></li>

                    </ol>
				</li>

			</ul>

		</div>
	</div>

</div>
               </div>
                <br />
               <div class="content box_border inputblock top bg_whiteSD">
                         <div class="box_border">
                                <a id="newfolder">新建文件夹</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="move">移动</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="del">删除</a> &nbsp;&nbsp;&nbsp;&nbsp;<div id="uploadfile"></div>                             
                           <br />  <br />
                             <table class="tblist" border="0">
                                 <tr><th style="width:50px"></th><th>文档名称</th><th>大小</th><th>文件类型</th><th>文档标签</th><th>来源</th><th>创建时间</th><th>审批时间</th><th>状态</th><th></th></tr>
                                 <tbody id="tblist-body"></tbody>
                             </table>

                                 <div id="notice_pages"></div>
                         </div>
                  
                </div>
            </div> 

           </div>       
        </div>
    </div>

	<div class="bodyMask">
		<div class="mask">
			<span class="fullScreen"></span>
			<div class="popup">
				<div class="model-title fl">上传文档</div>
				<i class="closed fr"></i>
				<div class="clearfix"></div>
				<hr />
	<br/>
				<div class="tbl-row">
						<div class="lable">上传:</div>
						<div class="ctrl">
							<div id="uploader" class="wu-example">
								<div id="picker" class="lable"></div>
								<div class="wu-example ctrl">
									<div id="thelist" class="uploader-list"></div>
								</div>
								<div class="ctrl">
									<button id="ctlBtn" class="btn btn-default" filestatus=0 >开始上传</button>
								</div>
							</div>
							</div>
				</div>

				<form method="post" id="ajaxform">
					<div class="tbl-row">
						<div class="lable">标题:</div>
						<div class="ctrl">
							<input type="text" id="name" name="name" class="inputBox" />
						</div>
					</div>
					
					<div class="tbl-row">
						<div class="lable">参战国家:</div>
						<div class="ctrl">
							<input type="text" id="warcountry" name="warcountry"
								class="inputBox" />
						</div>
					</div>
					<div class="tbl-row">
						<div class="lable">类型作战:</div>
						<div class="ctrl">
							<select id="combat_type" name="combat_type">
							<option value="1">西方战例</option>
							<option value="2 ">苏军战例</option>
							<option value="3">俄军战例</option>
							<option value="4 ">兵种战例</option>
							<option value="5">其他</option>
							</select>
						</div>
					</div>

					<div class="tbl-row">
						<div class="lable">参战兵种:</div>
						<div class="ctrl">
							<select id="arms" name="arms">
								<option value="1">步兵</option>
								<option value="2">装甲兵</option>
								<option value="3">通信兵</option>
								<option value="4">炮兵</option>
							</select>
						</div>
					</div>
					<div class="tbl-row">
						<div class="lable">参战地址:</div>
						<div class="ctrl">
							<input type="text" id="waraddr" name="waraddr" class="inputBox" />
						</div>
					</div>
					<div class="tbl-row">
						<div class="lable">参战时间:</div>
						<div class="ctrl">
							<input type="date" id="wartime" name="wartime" class="inputBox" />
						</div>
					</div>
					<div class="tbl-row">
						<div class="lable">胜利方:</div>
						<div class="ctrl">
							<input type="text" id="winner" name="winner" class="inputBox" />
						</div>
					</div>
					<div class="tbl-row">
						<div class="lable">失败方:</div>
						<div class="ctrl">
							<input type="text" id="loser" name="loser" class="inputBox" />
						</div>
					</div>

					<div class="tbl-row">
						<div class="lable">伤亡人数:</div>
						<div class="ctrl">
							<input type="text" id="warnum" name="warnum" class="inputBox" />
						</div>
					</div>
					<div class="tbl-row">
					<div class="lable">标签:</div>
						<div class="ctrl">
							<ul class='tag-ul'>
								<li class='tag-li'>#战役#</li>
								<li class='tag-li'>#解析#</li>
								<li class='tag-li'>#讲解#</li>
								<li class='tag-li'>#讨论#</li>
							</ul>
						</div>
					</div>
					<div class="tbl-row">
						<div class="lable">摘要:</div>
						<div class="ctrl">
							<textarea rows="10" cols="50"
								style="width: 79%; border: 1px solid #cccccc;" id="description"
								name="description"></textarea>
						</div>
					</div>
				</form>
				

				<div class="tbl-row">
					<div class="lable"></div>
					<div class="ctrl">
						<div id=submit class="submit"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

</body>
<script src="js/management.js"></script>
    <script>

        $(function () {
            $("#submit").click(function () {
                formSubmit();
            })
            function formSubmit(){
                var form = $("#ajaxform");

                if($("#thelist").find(".item").length==0){
                    alert("请上传文档");
                    return 
                }
                var filestatus = $('#ctlBtn').attr("filestatus");
                if(filestatus==0){
                    alert("您的文件未上传");
                    return 
                }
                if(""==$("#name").val()){
                    alert("请输入标题");
                    return 
                }
                var formdata ={};
                for (var i = 0; i < form.serializeArray().length; i++) {
                	var key = form.serializeArray()[i].name;
                	var value = form.serializeArray()[i].value;
                    formdata[key] = value;
                }
                $("#thelist").find(".item").each(function(){
                    formdata.filemd5 = $(this).attr("filemd5");
                    formdata.filename = $(this).attr("filename");
                    formdata.filesize = $(this).attr("filesize");
			 
                });
                $.ajax({
                    url: "phoibe/document/save",
                    type: form.attr("method"),
                    data: JSON.stringify(formdata), 
                    dataType: "json",
                    contentType:"application/json;charset=UTF-8",
                    success: function (data)
                    {
                        if(data.success){
                            alert("提交成功");
                            $(".bodyMask").hide();
                        }
                    }
                });
            };

            $("#ctlBtn").hide();
            var $btn = $('#ctlBtn');
            var $thelist = $('#thelist');
            var chunkSize = 5 * 1024 * 1024;

            // HOOK 这个必须要再uploader实例化前面
            WebUploader.Uploader.register({
                'before-send-file': 'beforeSendFile',
                'before-send': 'beforeSend'
            }, {
                beforeSendFile: function (file) {
                    console.log("beforeSendFile");
                    // Deferred对象在钩子回掉函数中经常要用到，用来处理需要等待的异步操作。
                    var task = new $.Deferred();
                    uploader.md5File(file).progress(function (percentage) {   // 及时显示进度
                        console.log('计算md5进度:', percentage);
                        getProgressBar(file, percentage, "MD5", "MD5");
                        $('#' + file.id).find('p.state').text("文件解析中...");
                    }).then(function (val) { // 完成
                        console.log('md5 result:', val);
                        file.md5 = val;
                        // 模拟用户id
                        // file.uid = new Date().getTime() + "_" + Math.random() * 100;
                        file.uid = WebUploader.Base.guid();
                        // 进行md5判断
                        $.post("phoibe/uopload/checkFileMd5", { filename: file.name, uid: file.uid, md5: file.md5 },
                                function (data) {
                                    console.log(data.status);
                                    var status = data.status.value;
                                    task.resolve();
                                    if (status == 101) {
                                        // 文件不存在，那就正常流程
                                    } else if (status == 100) {
                                        // 忽略上传过程，直接标识上传成功；
                                        uploader.skipFile(file);
                                        file.pass = true;
                                    } else if (status == 102) {
                                        // 部分已经上传到服务器了，但是差几个模块。
                                        file.missChunks = data.data;
                                    }
                                });
                    });
                    return $.when(task);
                },
                beforeSend: function (block) {
                    console.log("block")
                    var task = new $.Deferred();
                    var file = block.file;
                    var missChunks = file.missChunks;
                    var blockChunk = block.chunk;
                    console.log("当前分块：" + blockChunk);
                    console.log("missChunks:" + missChunks);
                    if (missChunks !== null && missChunks !== undefined && missChunks !== '') {
                        var flag = true;
                        for (var i = 0; i < missChunks.length; i++) {
                            if (blockChunk == missChunks[i]) {
                                console.log(file.name + ":" + blockChunk + ":还没上传，现在上传去吧。");
                                flag = false;
                                break;
                            }
                        }
                        if (flag) {
                            task.reject();
                        } else {
                            task.resolve();
                        }
                    } else {
                        task.resolve();
                    }
                    return $.when(task);
                }
            });

            // 实例化
            var uploader = WebUploader.create({
                pick: {
                    id: '#picker',
                    label: '选择文件'
                },
                formData: {
                    uid: 0,
                    md5: '',
                    chunkSize: chunkSize
                },
                //dnd: '#dndArea',
                //paste: '#uploader',
                swf: 'js/webuploader-0.1.5/Uploader.swf',
                chunked: true,
                chunkSize: chunkSize, // 字节 1M分块
                threads: 3,
                server: 'phoibe/uopload/fileUpload',
                auto: false,

                // 禁掉全局的拖拽功能。这样不会出现图片拖进页面的时候，把图片打开。
                disableGlobalDnd: true,
                fileNumLimit: 1024,
                fileSizeLimit: 1024 * 1024 * 1024,    // 200 M
                fileSingleSizeLimit: 1024 * 1024 * 1024    // 50 M
            });
            // 当有文件被添加进队列的时候
            uploader.on('fileQueued', function (file) {
                console.log("fileQueued");
                $thelist.append('<div id="' + file.id + '"  filename="' + file.name + '" class="item">' +
                        '<h4 class="info">' + file.name + '</h4>' +
                        '<div><progress max="100" value="0" id="' + file.id + '-progress"></progress><p class="state">等待上传...</p><div>' +
                        '</div>');
                $("#ctlBtn").show();
            });


            //当某个文件的分块在发送前触发，主要用来询问是否要添加附带参数，大文件在开起分片上传的前提下此事件可能会触发多次。
            uploader.onUploadBeforeSend = function (obj, data) {
                console.log("onUploadBeforeSend");
                var file = obj.file;
                data.md5 = file.md5 || '';
                data.uid = file.uid;
            };
            // 上传中
            uploader.on('uploadProgress', function (file, percentage) {
                getProgressBar(file, percentage, "FILE", "上传进度");
                $('#' + file.id).find('p.state').text("文件上传中...");
                $('#ctlBtn').attr("filestatus", "0");
            });
            // 上传返回结果
            uploader.on('uploadSuccess', function (file) {
                var text = '已上传';
                if (file.pass) {
                    text = "文件妙传功能，文件已上传。"
                }
                $('#' + file.id).find('p.state').text(text);
                $('#' + file.id).attr("filemd5", file.md5);
                $('#' + file.id).attr("fileSize", file.size);
                $('#ctlBtn').attr("filestatus", "1");
            });
            uploader.on('uploadError', function (file) {
                $('#' + file.id).find('p.state').text('上传出错');
            });
            uploader.on('uploadComplete', function (file) {
                // 隐藏进度条
                fadeOutProgress(file, 'MD5');
                fadeOutProgress(file, 'FILE');
            });
            // 文件上传
            $btn.on('click', function () {
                console.log("上传...");
                uploader.upload();
                console.log("上传成功");

            });

            /**
             *  生成进度条封装方法
             * @param file 文件
             * @param percentage 进度值
             * @param id_Prefix id前缀
             * @param titleName 标题名
             */
            function getProgressBar(file, percentage, id_Prefix, titleName) {
                var $li = $('#' + file.id + '-progress');
                var progressPercentage = percentage * 100;
                $li.val(progressPercentage);
            }

            /**
             * 隐藏进度条
             * @param file 文件对象
             * @param id_Prefix id前缀
             */
            function fadeOutProgress(file, id_Prefix) {
                $('#' + file.id + '-progress').fadeOut();
            }
        });

        $(".tag-li").click(function () {
            $(this).addClass("tag-li-in");
            $(".tag-li-in").click(function () {
                $(this).removeClass("tag-li-in");
                $(".tag-li").click(function () {
                    $(this).addClass("tag-li-in");
                });
            })
        });
			</script>
</html>